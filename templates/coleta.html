{% extends "base.html" %}
{% block title %}Coleta - WADE COLETOR{% endblock %}
{% block content %}
  <section class="panel">
    <div class="coleta-header">
      <h2 class="panel-title">📱 Coletar produtos</h2>
      <div class="empresa-info">
        <p class="empresa-nome">{{ nome_empresa }}</p>
        <div class="empresa-actions">
          <a href="{{ url_for('empresa_dashboard') }}" class="btn-link primary">📊 Dashboard</a>
          <a href="{{ url_for('logout_empresa') }}" class="btn-link danger">🚪 Sair</a>
        </div>
      </div>
    </div>
    <!-- Minimal instruction removed per user request -->

    <div style="text-align:center; margin-bottom:12px;">
      <button id="newCollectionBtn" class="btn primary" type="button" style="padding:12px 18px;">NOVA COLETA</button>
    </div>

    <form id="coletaForm" class="form-grid" method="POST" novalidate style="display:none;">
      <!-- campos com os mesmos 'name' usados no app.py -->
      <input name="empresa_nome" type="hidden" value="{{ nome_empresa }}" />

      <label class="field">
        <span>Nota fiscal</span>
        <input name="nota_fiscal" required placeholder="0000/0000" />
      </label>

      <label class="field">
        <span>Código de Barras</span>
        <div class="barcode-input-container">
          <input id="barcodeInput" name="barcode" placeholder="Digite ou escaneie o código de barras" />
          <button type="button" id="scanButton" class="btn-scan">
            📷 Escanear
          </button>
        </div>
        <div id="scanner-container" style="display: none;">
          <div class="scanner-header">
            <span class="scanner-status">📹 Posicione o código de barras na câmera</span>
          </div>
          <div id="scanner"></div>
          <div class="scanner-controls">
            <button type="button" id="stopScanButton" class="btn danger small">
              ⏹ Parar Scanner
            </button>
            <div class="scanner-tips">
              <small>💡 Mantenha o código bem iluminado e centralizado</small>
            </div>
          </div>
        </div>
      </label>

      <label class="field">
        <span>Nome do produto</span>
        <input name="product_name" placeholder="Produto X" />
      </label>

      <label class="field small">
        <span>Caixas recebidas</span>
        <input name="boxes_received" type="number" min="0" placeholder="0" />
      </label>

      <label class="field small">
        <span>Unidades por caixa</span>
        <input name="units_per_box" type="number" min="0" placeholder="0" />
      </label>

      <div class="form-actions">
        <button type="submit" class="btn primary">Enviar</button>
        <a href="{{ url_for('index') }}" class="btn ghost">Voltar</a>
      </div>
    </form>

    <!-- Modal simples para nome da coleta -->
    <div id="collectionModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); align-items:center; justify-content:center;">
      <div style="background:#fff; color:#071022; padding:18px; border-radius:10px; width:90%; max-width:420px; box-shadow:0 12px 40px rgba(2,6,23,0.5); margin:0 auto;">
        <h3 style="margin:0 0 8px; text-transform:uppercase; font-size:16px;">INFORME O NOME DA COLETA</h3>
        <input id="collectionName" placeholder="Ex: BALAN" style="width:100%; padding:10px; border-radius:8px; border:1px solid #cbd5e1; margin-bottom:12px;" />
        <div style="display:flex; gap:8px; justify-content:flex-end">
          <button id="cancelCollection" class="btn ghost" type="button" style="background:#f8fafc; color:#334155; border:1px solid rgba(15,23,40,0.04);">CANCELAR</button>
          <button id="confirmCollection" class="btn" type="button" style="background:#10b981; color:#fff; border:none;">AVANÇAR</button>
        </div>
      </div>
    </div>
  </section>

  <!-- ZXing-js Library - Scanner mais moderno -->
  <script src="https://unpkg.com/@zxing/library@latest/umd/index.min.js"></script>

  <script>
    // Modal logic for new collection
    (function(){
      const newBtn = document.getElementById('newCollectionBtn');
      const modal = document.getElementById('collectionModal');
      const cancel = document.getElementById('cancelCollection');
      const confirm = document.getElementById('confirmCollection');
      const nameInput = document.getElementById('collectionName');
      const form = document.getElementById('coletaForm');
      if(!newBtn || !modal || !cancel || !confirm || !nameInput || !form) return;
      function showModal(){ modal.style.display='flex'; }
      function hideModal(){ modal.style.display='none'; }
      newBtn.addEventListener('click', ()=>{ showModal(); nameInput.focus(); });
      cancel.addEventListener('click', ()=>{ hideModal(); });
      confirm.addEventListener('click', ()=>{
        const v = nameInput.value && nameInput.value.trim();
        if(!v){ alert('Informe um nome para a coleta.'); nameInput.focus(); return; }
        hideModal();
        form.style.display = '';
        window.scrollTo({ top: form.offsetTop - 40, behavior: 'smooth' });
      });
    })();

    // Modern Barcode Scanner Logic with ZXing-js
    (function(){
      const scanButton = document.getElementById('scanButton');
      const stopScanButton = document.getElementById('stopScanButton');
      const scannerContainer = document.getElementById('scanner-container');
      const barcodeInput = document.getElementById('barcodeInput');
      
      if(!scanButton || !stopScanButton || !scannerContainer || !barcodeInput) return;

      let codeReader = null;
      let scannerActive = false;
      let currentStream = null;

      scanButton.addEventListener('click', startScanner);
      stopScanButton.addEventListener('click', stopScanner);

      async function startScanner() {
        if (scannerActive) return;
        
        try {
          // Inicializa o leitor de código
          codeReader = new ZXing.BrowserMultiFormatReader();
          
          scannerContainer.style.display = 'block';
          scanButton.disabled = true;
          scanButton.textContent = '🔍 Iniciando câmera...';
          
          // Criar elemento de vídeo
          const videoElement = document.createElement('video');
          videoElement.id = 'scanner-video';
          videoElement.style.width = '100%';
          videoElement.style.height = '100%';
          videoElement.style.objectFit = 'cover';
          
          const scannerDiv = document.getElementById('scanner');
          scannerDiv.innerHTML = '';
          scannerDiv.appendChild(videoElement);

          // Listar dispositivos de vídeo disponíveis
          const videoInputDevices = await ZXing.BrowserCodeReader.listVideoInputDevices();
          console.log('Dispositivos de vídeo encontrados:', videoInputDevices.length);
          
          // Preferir câmera traseira se disponível
          let selectedDeviceId = null;
          if (videoInputDevices.length > 0) {
            const backCamera = videoInputDevices.find(device => 
              device.label.toLowerCase().includes('back') || 
              device.label.toLowerCase().includes('traseira') ||
              device.label.toLowerCase().includes('environment')
            );
            selectedDeviceId = backCamera ? backCamera.deviceId : videoInputDevices[0].deviceId;
          }

          scanButton.textContent = '📷 Escaneando...';
          scannerActive = true;

          // Iniciar o scanner
          const result = await codeReader.decodeOnceFromVideoDevice(selectedDeviceId, 'scanner-video');
          
          if (result) {
            const code = result.text;
            console.log("Código detectado:", code);
            
            // Preenche o input com o código detectado
            barcodeInput.value = code;
            
            // Para o scanner automaticamente após detectar
            stopScanner();
            
            // Foca no próximo campo
            const nextField = barcodeInput.closest('.field').nextElementSibling?.querySelector('input');
            if (nextField) {
              nextField.focus();
            }
            
            // Feedback visual de sucesso
            barcodeInput.style.backgroundColor = '#d4edda';
            barcodeInput.style.borderColor = '#10b981';
            setTimeout(() => {
              barcodeInput.style.backgroundColor = '';
              barcodeInput.style.borderColor = '';
            }, 3000);

            // Mostrar notificação de sucesso
            showNotification('✅ Código escaneado com sucesso!', 'success');
          }

        } catch (err) {
          console.error('Erro ao inicializar scanner:', err);
          let errorMessage = 'Erro ao acessar a câmera. ';
          
          if (err.name === 'NotAllowedError') {
            errorMessage += 'Permissão negada. Clique no ícone da câmera na barra de endereços e permita o acesso.';
          } else if (err.name === 'NotFoundError') {
            errorMessage += 'Nenhuma câmera encontrada no dispositivo.';
          } else if (err.name === 'NotSupportedError') {
            errorMessage += 'Scanner não suportado neste navegador.';
          } else {
            errorMessage += 'Verifique se deu permissão para usar a câmera.';
          }
          
          showNotification('❌ ' + errorMessage, 'error');
          stopScanner();
        }
      }

      function stopScanner() {
        if (!scannerActive) return;
        
        try {
          if (codeReader) {
            codeReader.reset();
            codeReader = null;
          }
          
          // Parar todas as streams de vídeo
          const videoElement = document.getElementById('scanner-video');
          if (videoElement && videoElement.srcObject) {
            const tracks = videoElement.srcObject.getTracks();
            tracks.forEach(track => track.stop());
            videoElement.srcObject = null;
          }
          
          scannerContainer.style.display = 'none';
          scannerActive = false;
          scanButton.disabled = false;
          scanButton.textContent = '📷 Escanear';
          
          // Limpar o container do scanner
          const scannerDiv = document.getElementById('scanner');
          if (scannerDiv) {
            scannerDiv.innerHTML = '';
          }
          
        } catch (err) {
          console.error('Erro ao parar scanner:', err);
        }
      }

      // Função para mostrar notificações
      function showNotification(message, type = 'info') {
        // Remove notificação existente
        const existingNotification = document.querySelector('.scanner-notification');
        if (existingNotification) {
          existingNotification.remove();
        }

        const notification = document.createElement('div');
        notification.className = `scanner-notification ${type}`;
        notification.textContent = message;
        notification.style.cssText = `
          position: fixed;
          top: 80px;
          left: 50%;
          transform: translateX(-50%);
          background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#3b82f6'};
          color: white;
          padding: 12px 20px;
          border-radius: 8px;
          font-size: 14px;
          font-weight: 600;
          box-shadow: 0 4px 12px rgba(0,0,0,0.3);
          z-index: 1000;
          max-width: 90%;
          text-align: center;
          animation: slideDown 0.3s ease;
        `;

        document.body.appendChild(notification);

        // Remove após 4 segundos
        setTimeout(() => {
          if (notification.parentNode) {
            notification.style.animation = 'slideUp 0.3s ease';
            setTimeout(() => notification.remove(), 300);
          }
        }, 4000);
      }

      // Parar o scanner se o usuário sair da página
      window.addEventListener('beforeunload', stopScanner);
      
      // Parar scanner se a aba perder o foco
      document.addEventListener('visibilitychange', () => {
        if (document.hidden && scannerActive) {
          stopScanner();
        }
      });
    })();
  </script>
{% endblock %}
